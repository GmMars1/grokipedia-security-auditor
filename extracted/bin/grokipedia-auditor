#!/bin/bash
# GrokiPedia Security Auditor - Main Executable
# Version: v2.3.1-solidity

set -euo pipefail

# Global variables
readonly SCRIPT_NAME="grokipedia-auditor"
readonly VERSION="v2.3.1-solidity"
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
readonly LOG_FILE="${SCRIPT_DIR}/logs/auditor.log"

# Ensure log directory exists
mkdir -p "${SCRIPT_DIR}/logs"

# Source libraries
source_lib() {
    local lib_path="$1"
    if [[ -f "${SCRIPT_DIR}/lib/${lib_path}" ]]; then
        source "${SCRIPT_DIR}/lib/${lib_path}"
    else
        echo "Error: Required library ${lib_path} not found!" >&2
        exit 1
    fi
}

source_lib "core.sh"
source_lib "security.sh"
source_lib "affiliate.sh"

# Initialize logging
init_logging() {
    touch "$LOG_FILE" 2>/dev/null || {
        echo "Warning: Cannot create log file $LOG_FILE" >&2
    }
}

# Main function
main() {
    init_logging
    
    case "${1:-}" in
        "audit")
            shift
            if [[ $# -eq 0 ]]; then
                log_error "URL is required for audit command"
                show_help
                exit 1
            fi
            run_audit "$@"
            ;;
        "content-audit")
            shift
            if [[ $# -eq 0 ]]; then
                log_error "URL is required for content-audit command"
                show_help
                exit 1
            fi
            run_content_audit "$@"
            ;;
        "affiliate")
            shift
            handle_affiliate "$@"
            ;;
        "deploy")
            shift
            deploy_site "$@"
            ;;
        "version")
            echo "GrokiPedia Security Auditor ${VERSION}"
            ;;
        "help"|"--help"|"-h"|"")
            show_help
            ;;
        *)
            log_error "Unknown command: ${1:-}"
            show_help
            exit 1
            ;;
    esac
}

show_help() {
    cat << EOL
GrokiPedia Security Auditor ${VERSION}

USAGE:
    grokipedia-auditor <command> [options]

COMMANDS:
    audit <url>          Run comprehensive security audit on website
    content-audit <url>  Run content-specific audit (as per README)
    affiliate <action>   Manage affiliate operations
    deploy <domain>      Deploy to production
    version              Show version information
    help                 Show this help message

EXAMPLES:
    grokipedia-auditor audit https://example.com
    grokipedia-auditor content-audit https://example.com --report audit.json
    grokipedia-auditor affiliate --generate-link
    grokipedia-auditor deploy example.com

For more information, visit: https://github.com/Gmmars1/grokipedia-security-auditor
EOL
}

main "$@"
